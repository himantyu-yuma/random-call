<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バーチャル廊下</title>
    <!-- bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        body {
            background-image: url(img/background.JPG);
            background-size: cover;
        }

        video {
            border: 1px solid #000;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header text-center">
            <img src="img/title.png" alt="">
        </div>
        <div class="text-center mt-5">
            <video id="friend" width="480" height="270" autoplay muted="true" controls></video>
        </div>
    </div>
    <audio src="audio/bell.mp3" id="bell"></audio>

    <!-- bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/8.0.2/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/8.0.2/firebase-auth.js"></script>
    <script defer src="/__/firebase/8.0.2/firebase-database.js"></script>
    <script defer src="/__/firebase/8.0.2/firebase-messaging.js"></script>
    <script defer src="/__/firebase/8.0.2/firebase-storage.js"></script>
    <script defer src="/__/firebase/8.0.2/firebase-analytics.js"></script>
    <script defer src="/__/firebase/8.0.2/firebase-remote-config.js"></script>
    <script defer src="/__/firebase/8.0.2/firebase-performance.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <!-- Sky-way -->
    <script src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>

    <script src="js/key.js"></script>
    <script>
        (async function main() {

            const friends = ['taro', 'hanako', 'takashi'];
            const friendVideo = document.getElementById('friend');
            // メディア情報
            const localStream = await navigator.mediaDevices.getUserMedia({
                video: { width: {ideal: 480 }, height: {ideal: 270 } },
                audio: true
            });
            // ランダムなユーザー名を返す
            const getRandomUser = userArr => {
                const target = userArr[Math.floor(Math.random() * userArr.length)];
                return target;
            }
            // peerオブジェクト生成
            const peer = new Peer('username', {
                key: window.__SKYWAY_KEY__,
                debug: 3,
            });
            // 通話開始
            const startCall = async (peerId) => {
                const call = peer.call(peerId, localStream);
                // メディア情報を取得できたとき
                call.on('stream', stream => {
                    friendVideo.srcObject = stream;
                    // // 一定時間で切る
                    // setTimeout(() => {
                    //     mediaConnection.close(true)
                    // }, 10000);
                });
                // 通話が終了した時
                call.once('close', () => {
                    friendVideo.srcObject.getTracks().forEach(track => {
                        track.stop();
                    });
                    friendVideo.srcObject = null;
                });
            }

            // 通話がつながった時
            peer.on('call', mediaConnection => {
                mediaConnection.answer(localStream);
                // メディア情報を取得できたとき
                mediaConnection.on('stream', stream => {
                    friendVideo.srcObject = stream;
                    // 一定時間で切る
                    setTimeout(() => {
                        document.getElementById('bell').play();
                        setTimeout(() => {
                            mediaConnection.close(true);
                        }, 10000);
                    }, 10000);
                });
                // 通話が終了した時
                mediaConnection.once('close', () => {
                    friendVideo.srcObject.getTracks().forEach(track => {
                        track.stop();
                    });
                    friendVideo.srcObject = null;
                });
            });
        })();
    </script>
</body>

</html>